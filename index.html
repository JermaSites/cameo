<!DOCTYPE html>
<html>

<head>
<script src="https://unpkg.com/blob-util/dist/blob-util.min.js"></script>
<script src="https://raw.githack.com/yusitnikov/fix-webm-duration/master/fix-webm-duration.js"></script>
</head>

<body>
  <br>
  <video id="videoTag" onplay="recordMe()" onended="done()" controls="true" autoplay="true"></video>

  <script>
  
    (async() => {

      const mediaSource = new MediaSource();

      const video = document.getElementById("videoTag");

      // video.oncanplay = e => video.play();

      const urls = ["videos/birthday01.webm", "videos/birthday02.webm", "videos/birthday03.webm"];

      const request = url => fetch(url).then(response => response.arrayBuffer());

      // `urls.reverse()` stops at `.currentTime` : `9`
      const files = await Promise.all(urls.map(request));

      /*
       `.webm` files
       Uncaught DOMException: Failed to execute 'appendBuffer' on 'SourceBuffer': This SourceBuffer has been removed from the parent media source.
       Uncaught DOMException: Failed to set the 'timestampOffset' property on 'SourceBuffer': This SourceBuffer has been removed from the parent media source.
      */
      const mimeCodec = 'video/webm; codecs="vp9,opus"';
      // https://stackoverflow.com/questions/14108536/how-do-i-append-two-video-files-data-to-a-source-buffer-using-media-source-api/
      //const mimeCodec = "video/mp4; codecs=avc1.42E01E, mp4a.40.2";


      const media = await Promise.all(files.map(file => {
        return new Promise(resolve => {
          let media = document.createElement("video");
          let blobURL = URL.createObjectURL(new Blob([file]));
          media.onloadedmetadata = async e => {
            resolve({
              mediaDuration: media.duration,
              mediaBuffer: file
            })
          }
          media.src = blobURL;
        })
      }));

      console.log(media);

      mediaSource.addEventListener("sourceopen", sourceOpen);

      video.src = URL.createObjectURL(mediaSource);

      async function sourceOpen(event) {

        if (MediaSource.isTypeSupported(mimeCodec)) {
          const sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);

          for (let chunk of media) {
            await new Promise(resolve => {
              sourceBuffer.appendBuffer(chunk.mediaBuffer);
              sourceBuffer.onupdateend = e => {
                sourceBuffer.onupdateend = null;
                sourceBuffer.timestampOffset += chunk.mediaDuration;
                console.log(mediaSource.duration);
                console.log(mediaSource);
                resolve()
              }
            })

          }

          mediaSource.endOfStream();
        }  
        else {
          console.warn(mimeCodec + " not supported");
        }
      };

    })()

      var mediaRecorder;
      var mediaParts;
      var startTime;
      const video = document.getElementById("videoTag");
      // Optional frames per second argument.

      var stream = video.captureStream(60);
      //var stream = video.mozCaptureStream(60);

      var options = { 
        mimeType: 'video/webm; codecs="vp9,opus"'
      };
      
      function startRecording(stream, options) {
          mediaParts = [];
          mediaRecorder = new MediaRecorder(stream, options);
          mediaRecorder.onstop = function() {
              var duration = Date.now() - startTime;
              var buggyBlob = new Blob(mediaParts, { type: 'video/webm' });
              
              ysFixWebmDuration(buggyBlob, duration, function(fixedBlob) {
                  displayResult(fixedBlob);
              });
          };
          mediaRecorder.ondataavailable = function(event) {
              var data = event.data;
              if (data && data.size > 0) {
                  mediaParts.push(data);
              }
          };
          mediaRecorder.start();
          startTime = Date.now();
      }

      function stopRecording() {
          mediaRecorder.stop();
      }

      function displayResult(fixedBlob) {
        var url = URL.createObjectURL(fixedBlob);
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        a.href = url;
        a.download = "test.webm";
        a.click();
        window.URL.revokeObjectURL(url);
      }
    
    function recordMe() {
      startRecording(stream, options);
    }

    function done() {
      mediaRecorder.stop();
    }
    


  </script>


</body>

</html>
